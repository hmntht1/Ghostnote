<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostNote - Vanishing Chat</title>
    <!-- Load React, ReactDOM, and Tailwind CSS from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-neutral-950">
    <div id="root"></div>

    <script type="module">
        // --- REACT SETUP ---
        const React = window.React;
        const { useState, useEffect, useRef } = React;
        const ReactDOM = window.ReactDOM;

        // Custom Icon wrapper for Lucide (since we're using CDN)
        const Icon = ({ name, className, ...props }) => {
            const IconComponent = lucide.icons[name];
            return IconComponent ? React.createElement(IconComponent, { className, ...props }) : null;
        };
        const Ghost = (props) => React.createElement(Icon, { name: 'Ghost', ...props });
        const Send = (props) => React.createElement(Icon, { name: 'Send', ...props });
        const Eye = (props) => React.createElement(Icon, { name: 'Eye', ...props });
        const X = (props) => React.createElement(Icon, { name: 'X', ...props });
        const Clock = (props) => React.createElement(Icon, { name: 'Clock', ...props });
        const Search = (props) => React.createElement(Icon, { name: 'Search', ...props });
        const RefreshCw = (props) => React.createElement(Icon, { name: 'RefreshCw', ...props });
        const Trash2 = (props) => React.createElement(Icon, { name: 'Trash2', ...props });
        const Terminal = (props) => React.createElement(Icon, { name: 'Terminal', ...props });
        const ImageIcon = (props) => React.createElement(Icon, { name: 'Image', ...props });
        const Key = (props) => React.createElement(Icon, { name: 'Key', ...props });

        // --- FIREBASE IMPORTS (from CDN) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, query, where, onSnapshot, 
            deleteDoc, doc, serverTimestamp, getDocs, setDoc, limit 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (Your Private Keys from 'ghostchat-55b5f') ---
        const firebaseConfig = {
            apiKey: "AIzaSyCkPEVGWMTQI_R9SJjB...", 
            authDomain: "ghostchat-55b5f.firebaseapp.com",
            projectId: "ghostchat-55b5f",
            storageBucket: "ghostchat-55b5f.appspot.com",
            messagingSenderId: "837153770265",
            appId: "1:837153770265:web:388880..."
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CLOUDINARY CONFIG (Your Private Keys) ---
        const CLOUD_NAME = "darf8cdlk"; 
        const UPLOAD_PRESET = "Ghost_upload"; 
        // ---------------------------------------------

        // --- CORE APPLICATION LOGIC (App, ComposeForm, etc. functions) ---
        // (Implementation details of App and ComposeForm are omitted here for conciseness 
        // but are fully contained in the running script below)

        function App() {
            const [user, setUser] = useState(null);
            const [username, setUsername] = useState("");
            const [view, setView] = useState('onboarding'); 
            const [messages, setMessages] = useState([]);
            const [activeMessage, setActiveMessage] = useState(null);
            const [content, setContent] = useState(null); 
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState("");

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        if (currentUser.displayName) {
                            setUsername(currentUser.displayName);
                            await setDoc(doc(db, "users", currentUser.uid), {
                                username: currentUser.displayName,
                                uid: currentUser.uid,
                                lastActive: serverTimestamp()
                            }, { merge: true });
                            setView('inbox');
                        } else {
                            setView('onboarding');
                        }
                    } else {
                        signInAnonymously(auth).catch((err) => console.error("Auth failed", err));
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, "messages"), where("recipientId", "==", user.uid));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), isMedia: !!doc.data().mediaURL }));
                    msgs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setMessages(msgs);
                });
                return () => unsubscribe();
            }, [user]);

            const handleJoin = async (chosenName) => {
                if (!chosenName || chosenName.length < 3) { setError("Username must be 3+ chars"); return; }
                setLoading(true);
                try {
                    await updateProfile(auth.currentUser, { displayName: chosenName });
                    await setDoc(doc(db, "users", auth.currentUser.uid), { username: chosenName, uid: auth.currentUser.uid, createdAt: serverTimestamp() });
                    setUsername(chosenName);
                    setView('inbox');
                } catch (err) { console.error(err); setError("Failed to join. Try again."); }
                setLoading(false);
            };

            const handleSendMessage = async (recipientUsername, text, file) => {
                if (!text && !file) return;
                setLoading(true);
                let mediaURL = null;
                let isMedia = !!file;

                try {
                    const q = query(collection(db, "users"), where("username", "==", recipientUsername), limit(1));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) { throw new Error("User not found"); }
                    const recipientData = querySnapshot.docs[0].data();
                    
                    if (isMedia) {
                        if (!CLOUD_NAME || !UPLOAD_PRESET) { throw new Error("Cloudinary configuration missing."); }
                        const formData = new FormData();
                        formData.append("file", file);
                        formData.append("upload_preset", UPLOAD_PRESET);
                        const uploadResponse = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: formData });
                        const uploadData = await uploadResponse.json();
                        if (uploadData.error) { throw new Error(`Cloudinary upload failed: ${uploadData.error.message}`); }
                        mediaURL = uploadData.secure_url;
                    }
                    
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 30);

                    const messagePayload = {
                        recipientId: recipientData.uid,
                        senderUsername: username,
                        createdAt: serverTimestamp(),
                        expiresAt: expiryDate,
                        read: false,
                        text: text || null, mediaURL: mediaURL || null, fileName: file ? file.name : null
                    };

                    await addDoc(collection(db, "messages"), messagePayload);
                    setView('inbox');
                } catch (err) { alert(`Error sending message: ${err.message}`); }
                setLoading(false);
            };

            const openMessage = async (msg) => {
                setLoading(true);
                try {
                    setActiveMessage(msg);
                    setView('reading');
                    if (msg.isMedia) { setContent({ isMedia: true, url: msg.mediaURL, fileName: msg.fileName, text: msg.text }); } 
                    else { setContent({ isMedia: false, text: msg.text }); }
                } catch (err) { console.error(err); alert("Could not load message."); setLoading(false); setView('inbox'); }
                setLoading(false);
            };

            const closeAndBurn = async () => {
                if (activeMessage) {
                    try { await deleteDoc(doc(db, "messages", activeMessage.id)); } 
                    catch (e) { console.log("DB message already deleted or error:", e); }
                }
                setActiveMessage(null);
                setContent(null);
                setView('inbox');
            };

            // --- RENDER ---
            if (loading && view === 'onboarding') {
                return React.createElement('div', { className: "min-h-screen bg-black text-lime-400 flex items-center justify-center font-mono" },
                    React.createElement('div', { className: "animate-pulse flex flex-col items-center gap-4" },
                        React.createElement(Ghost, { className: "w-12 h-12" }),
                        React.createElement('p', null, "INITIALIZING UPLINK...")
                    )
                );
            }

            return (
                <div className="min-h-screen bg-neutral-950 text-neutral-100 font-sans selection:bg-lime-500/30">
                    <header className="fixed top-0 w-full z-50 bg-neutral-950/80 backdrop-blur-md border-b border-neutral-800 p-4 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-lime-400 rounded-lg flex items-center justify-center shadow-[0_0_15px_rgba(163,230,53,0.5)]">
                                <Ghost className="w-5 h-5 text-black" />
                            </div>
                            <span className="font-bold tracking-tighter text-xl">GHOST<span className="text-lime-400">NOTE</span></span>
                        </div>
                        {username && (
                            <div className="text-xs font-mono text-neutral-500 flex items-center gap-2">
                                <div className="w-2 h-2 rounded-full bg-lime-500 animate-pulse"></div>
                                {username}
                            </div>
                        )}
                    </header>
                    <main className="pt-20 pb-4 px-4 max-w-md mx-auto min-h-screen flex flex-col">
                        
                        {/* ONBOARDING, INBOX, COMPOSE, READING VIEWS GO HERE */}

                        {view === 'onboarding' && React.createElement('div', { className: "flex-1 flex flex-col justify-center items-center space-y-8 fade-in" },
                            React.createElement('div', { className: "text-center space-y-2" },
                                React.createElement('h1', { className: "text-4xl font-black tracking-tighter" }, "Vanish.", React.createElement('br'), "Without a trace."),
                                React.createElement('p', { className: "text-neutral-400" }, "Instant-Delete. Media Supported.")
                            ),
                            React.createElement('div', { className: "w-full space-y-4 bg-neutral-900 p-6 rounded-2xl border border-neutral-800" },
                                React.createElement('div', { className: "space-y-2" },
                                    React.createElement('label', { className: "text-xs uppercase tracking-widest text-neutral-500 font-bold" }, "Identify Yourself"),
                                    React.createElement('input', { type: "text", placeholder: "Enter alias...", className: "w-full bg-neutral-950 border border-neutral-800 rounded-xl p-4 text-lg focus:border-lime-400 focus:outline-none transition-colors", id: "username-input" })
                                ),
                                React.createElement('button', { onClick: () => handleJoin(document.getElementById('username-input').value), className: "w-full bg-lime-400 hover:bg-lime-300 text-black font-bold p-4 rounded-xl flex items-center justify-center gap-2 transition-transform active:scale-95" },
                                    React.createElement(Terminal, { className: "w-5 h-5" }), "Initialize Uplink"
                                ),
                                error && React.createElement('p', { className: "text-red-500 text-center text-sm" }, error)
                            ),
                            React.createElement('div', { className: "text-[10px] text-neutral-600 max-w-xs text-center" }, "This app deletes content immediately after reading. It does NOT use E2E encryption.")
                        )}

                        {view === 'inbox' && React.createElement('div', { className: "flex-1 flex flex-col" },
                            React.createElement('div', { className: "flex justify-between items-end mb-6" },
                                React.createElement('h2', { className: "text-2xl font-bold" }, "Inbox"),
                                React.createElement('button', { onClick: () => setView('compose'), className: "bg-neutral-800 hover:bg-neutral-700 text-white p-2 rounded-full transition-colors" }, React.createElement(Send, { className: "w-5 h-5" }))
                            ),
                            messages.length === 0 ? (
                                React.createElement('div', { className: "flex-1 flex flex-col items-center justify-center text-neutral-600 space-y-4" },
                                    React.createElement('div', { className: "w-16 h-16 rounded-full bg-neutral-900 flex items-center justify-center" }, React.createElement(Clock, { className: "w-8 h-8 opacity-20" })), React.createElement('p', null, "No active signals."))
                            ) : (
                                React.createElement('div', { className: "space-y-3" }, messages.map(msg => (
                                    React.createElement('div', { key: msg.id, onClick: () => openMessage(msg), className: "group relative overflow-hidden bg-neutral-900 hover:bg-neutral-800 border border-neutral-800 p-4 rounded-2xl transition-all active:scale-[0.98] cursor-pointer" },
                                        React.createElement('div', { className: "flex justify-between items-start" },
                                            React.createElement('div', { className: "flex items-center gap-3" },
                                                React.createElement('div', { className: `w-10 h-10 rounded-full flex items-center justify-center border ${msg.isMedia ? 'bg-indigo-900 border-indigo-500/30' : 'bg-purple-900 border-purple-500/30'}` }, msg.isMedia ? React.createElement(ImageIcon, { className: "w-4 h-4 text-indigo-400" }) : React.createElement(Key, { className: "w-4 h-4 text-purple-400" })),
                                                React.createElement('div', null, React.createElement('div', { className: "font-bold text-neutral-200" }, msg.senderUsername), React.createElement('div', { className: "text-xs text-neutral-500 font-mono" }, msg.isMedia ? 'Media Message' : 'Text Message'))
                                            ),
                                            React.createElement('div', { className: "text-[10px] text-neutral-600 bg-neutral-950 px-2 py-1 rounded-full" }, "30d EXP")
                                        ),
                                        React.createElement('div', { className: "absolute bottom-0 left-0 w-full h-1 bg-purple-500/20" })
                                    )
                                ))
                            ),
                            React.createElement('button', { onClick: () => setView('compose'), className: "fixed bottom-6 right-6 w-14 h-14 bg-lime-400 hover:bg-lime-300 text-black rounded-full shadow-lg shadow-lime-400/20 flex items-center justify-center transition-transform active:scale-90" }, React.createElement(Send, { className: "w-6 h-6 ml-1" }))
                        )}

                        {view === 'compose' && React.createElement('div', { className: "flex-1 flex flex-col" },
                            React.createElement('div', { className: "flex items-center gap-4 mb-6" },
                                React.createElement('button', { onClick: () => setView('inbox'), className: "p-2 -ml-2 hover:bg-neutral-900 rounded-full" }, React.createElement(X, { className: "w-6 h-6" })),
                                React.createElement('h2', { className: "text-xl font-bold" }, "New Secret")
                            ), React.createElement(ComposeForm, { onSend: handleSendMessage, loading: loading })
                        )}

                        {view === 'reading' && React.createElement('div', { className: "fixed inset-0 z-[100] bg-black flex flex-col" },
                            React.createElement('div', { className: "flex-1 flex flex-col items-center justify-center p-8 text-center space-y-8 overflow-y-auto" },
                                React.createElement('div', { className: "w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center animate-pulse" }, React.createElement(Eye, { className: "w-8 h-8 text-red-500" })),
                                content?.isMedia ? (
                                    React.createElement('div', { className: "space-y-4" },
                                        React.createElement('img', { src: content.url, alt: "Media content", className: "max-w-full max-h-80 object-contain rounded-xl border border-neutral-700" }),
                                        content.text && React.createElement('p', { className: "text-lg text-neutral-200" }, content.text),
                                        React.createElement('div', { className: "text-xs text-neutral-500 font-mono" }, "File: ", content.fileName)
                                    )
                                ) : (
                                    React.createElement('div', { className: "space-y-2" },
                                        React.createElement('div', { className: "text-xs uppercase tracking-widest text-neutral-500" }, "From ", activeMessage?.senderUsername),
                                        React.createElement('div', { className: "text-2xl md:text-3xl font-medium text-white leading-relaxed break-words" }, "\"", content?.text, "\"")
                                    )
                                ),
                                React.createElement('div', { className: "text-xs text-neutral-600 max-w-xs pt-8" }, "Caution: This message and any attached media will be permanently deleted from the database when you close this screen. (The media file itself remains on Cloudinary for administrative cleanup).")
                            ),
                            React.createElement('button', { onClick: closeAndBurn, className: "m-6 p-6 bg-red-600 hover:bg-red-500 text-white font-bold rounded-2xl flex items-center justify-center gap-2 shadow-[0_0_30px_rgba(220,38,38,0.4)] transition-all active:scale-95" }, React.createElement(Trash2, { className: "w-6 h-6" }), "Close & Destroy")
                        )}
                    </main>
                </div>
            );
        }

        // Sub-component for Composition 
        function ComposeForm({ onSend, loading }) {
            const [target, setTarget] = useState("");
            const [msg, setMsg] = useState("");
            const [file, setFile] = useState(null);
            const fileInputRef = useRef(null);

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile && selectedFile.size > 5 * 1024 * 1024) { alert("File size limit is 5MB for this demo."); setFile(null); } 
                else { setFile(selectedFile); }
            };
            const handleSubmit = () => { onSend(target, msg, file); setMsg(""); setFile(null); if (fileInputRef.current) fileInputRef.current.value = ""; };
            const isSendDisabled = loading || !target || (!msg && !file);

            return (
                <div className="space-y-6 animate-in slide-in-from-bottom-10 fade-in duration-300">
                    <div className="space-y-2">
                        <label className="text-xs font-mono text-neutral-500 ml-1">RECIPIENT</label>
                        <div className="relative">
                            <Search className="absolute left-4 top-4 w-5 h-5 text-neutral-600" />
                            <input value={target} onChange={(e) => setTarget(e.target.value)} placeholder="Username..." className="w-full bg-neutral-900 border border-neutral-800 rounded-xl py-4 pl-12 pr-4 focus:border-purple-500 focus:outline-none" />
                        </div>
                    </div>

                    <div className="space-y-2">
                        <label className="text-xs font-mono text-neutral-500 ml-1">CONTENT</label>
                        <textarea value={msg} onChange={(e) => setMsg(e.target.value)} placeholder="Type message..." className="w-full h-24 bg-neutral-900 border border-neutral-800 rounded-xl p-4 resize-none focus:border-purple-500 focus:outline-none" />
                        
                        <div className="flex justify-between items-center pt-2">
                            <input type="file" ref={fileInputRef} accept="image/*" onChange={handleFileChange} className="hidden" id="file-upload-input" />
                            <label htmlFor="file-upload-input" className={`flex items-center gap-2 p-2 rounded-full text-xs font-bold transition-colors cursor-pointer ${file ? 'text-indigo-400 bg-indigo-900/50' : 'text-neutral-500 hover:text-neutral-300'}`}><ImageIcon className="w-4 h-4" />{file ? file.name : 'Attach Image (5MB Max)'}</label>
                            {file && (<button onClick={() => { setFile(null); if (fileInputRef.current) fileInputRef.current.value = ""; }} className="text-red-500 hover:text-red-400 p-1 rounded-full"><X className="w-4 h-4" /></button>)}
                        </div>
                    </div>

                    <button disabled={isSendDisabled} onClick={handleSubmit} className="w-full bg-purple-600 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-purple-500 text-white font-bold p-4 rounded-xl flex items-center justify-center gap-2 transition-all">
                        {loading ? React.createElement(RefreshCw, { className: "w-5 h-5 animate-spin" }) : React.createElement(Send, { className: "w-5 h-5" })}
                        Send Message
                    </button>
                </div>
            );
        }

        // --- THE CRUCIAL FIX: Ensure React Renders after all CDN scripts load ---
        window.onload = function() {
            ReactDOM.render(
                React.createElement(App),
                document.getElementById('root')
            );
        };
    </script>
</body>
</html>


